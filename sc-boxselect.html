<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../core-a11y-keys/core-a11y-keys.html">


<!--
sc-boxselect is custom input select element

##### Example

    <sc-boxselect></sc-boxselect>

@element sc-boxselect is custom input select element
@blurb Element provinding an input select easiest
@status beta
@homepage http://github.com/siscomando/sc-boxselect
-->
<polymer-element name="sc-boxselect" attributes="author showThumbs opened target limit">
  <template>
    <link rel="stylesheet" href="sc-boxselect.css">     
    <core-a11y-keys target="{{coreMenu}}" keys="enter" on-keys-pressed="{{selection}}"></core-a11y-keys>

      <div id="dropdop" class="boxselect">
        <core-menu id="coreMenu" class="menu" > 
          <template repeat="{{item in iterable}}">
            <paper-item tabIndex="-1" on-blur="{{close}}">
              <template bind if="{{showThumbs}}">
                <div class="expo thumb" style="background: url({{item.thumbnail}}); 
                background-size: cover; background-repeat: no-repeat;">
                </div>
              </template>
              <div class="expo content">{{item.content}}</div>
            </paper-item>
          </template>
        </core-menu>
      </div>
  
  </template>
  <script>
    Polymer('sc-boxselect', { 
       /**
       * Fired when an item is selected.
       *
       *
       * @event selected-user
       */        
      /*
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type String
       * @default 'Horacio Ibrahim'
       */ 
      /**
       * The `showThumbs` attribute show/hide thumbnail before the content.
       *
       * @attribute showThumbs
       * @type Boolean
       * @default true
       */  
      /**
       * The `opened` attribute sets if show (open) or not the box dialog.
       *
       * @attribute opened
       * @type Boolean
       * @default false
       */ 
      /**
       * The `target` attribute sets an element for align the box dialog.
       *
       * @attribute target
       * @type String
       * @default null
       */ 
      /**
       * The `limit` attribute sets the limit lines.
       *
       * @attribute limit
       * @type integer
       * @default 5
       */               
      author: 'Horacio Ibrahim',                  
      publish: {
        showThumbs: true,
        iterable: [],
        opened: false,
        target: null,
        limit: 5, // each item has 60.7813px
        maxHeight: 60.7813 * this.limit + "px", // 4 x 60.7813 = 243
      },
      ready: function() {
        this.coreMenu = this.$.coreMenu;
        this.$.dropdop.style.margin = 0;
        this.$.coreMenu.style.margin = 0;  
        this.targetElem = document.querySelector('#' + this.target);
        
        // ACAO QUANDO SELECIONADO ATIVO
        document.addEventListener('core-activate', function(){
          var mythis = this.querySelector('sc-boxselect');
          mythis.selection();
        });

      },  
      openedChanged: function() {
        if (this.opened == true) {
          this.$.dropdop.style.display = "block";  
          pi = this.$.dropdop.querySelector('paper-item ');
          pi.focus();
        } else {
          this.$.dropdop.style.display = "none";
        }
        
        this.setPosition(this.target, this.$.dropdop);
      },
      close: function() {
        this.opened = false;
      },
      selection: function() {
        var model = this.$.coreMenu.selectedModel;
        this.opened = false;
        this.fire('selected-user', {response: {'content': model.item.content, 
                                        'thumbnail': model.item.thumbnail}});
      },
      /**
       * Adds elements in box dialog but limited at limit attribute.
       *
       * @param thumbnail - sets the thumbnail 
       * @param content - sets the content 
       * @method setItems
       */ 
      setItems: function(thumbnail, content) {
        var data = {'thumbnail': thumbnail, 'content': content};
        if (this.iterable.length < this.limit) {
          this.iterable.push(data); // TODO add/push testesj
        }
      },
      /**
       * Clear all elements in box dialog.
       *
       * @method clearItems
       */       
      clearItems: function() {
        this.iterable = [];
      },      
      setPosition: function(targetElem, overlay) {
        var targetElem = targetElem;

        if (typeof targetElem == "string") {
          targetElem = document.querySelector('#' + targetElem);
        }
        
        overlay.style.position = "fixed";
        var rect = targetElem.getBoundingClientRect();
        h = targetElem.offsetHeight;
        t = rect.bottom // - overlay.offsetHeight;
        l = rect.left;
        w = rect.width;

        overlay.style.top = (t - overlay.offsetHeight - h) + "px";
        overlay.style.left = l + "px";
        overlay.style.width = w + "px";
      },
    });
  </script>

</polymer-element>
