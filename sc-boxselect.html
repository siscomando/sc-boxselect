<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../core-a11y-keys/core-a11y-keys.html">


<!--
sc-boxselect is custom input select element

##### Example

    <sc-boxselect></sc-boxselect>

@element sc-boxselect is custom input select element
@blurb Element provinding an input select easiest
@status beta
@homepage http://github.com/siscomando/sc-boxselect
-->
<polymer-element name="sc-boxselect" attributes="author showThumbs opened target limit">
  <template>
    <link rel="stylesheet" href="sc-boxselect.css">     
    <core-a11y-keys target="{{coreMenu}}" keys="enter" on-keys-pressed="{{selection}}"></core-a11y-keys>

      <paper-dialog id="dropdop" class="boxselect" style="font-family: 'RobotoDraft', sans-serif;">
        <core-menu id="coreMenu" class="menu"> 
          <template repeat="{{item in iterable}}">
            <paper-item autoFocus="true">
              <template bind if="{{showThumbs}}">
                <div class="expo thumb" style="width: 32px; height: 32px;
                background: url({{item.thumbnail}}); background-size: cover; 
                background-repeat: no-repeat;">
                </div>
              </template>
              <div class="expo content" style="margin-left: 8px; font-size: 0.98em;">{{item.content}}</div>
            </paper-item>
          </template>
        </core-menu>
      </paper-dialog>
  
  </template>
  <script>
    Polymer('sc-boxselect', { 
       /**
       * Fired when an item is selected.
       *
       *
       * @event selected-user
       */        
      /*
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type String
       * @default 'Horacio Ibrahim'
       */ 
      /**
       * The `showThumbs` attribute show/hide thumbnail before the content.
       *
       * @attribute showThumbs
       * @type Boolean
       * @default true
       */  
      /**
       * The `opened` attribute sets if show (open) or not the box dialog.
       *
       * @attribute opened
       * @type Boolean
       * @default false
       */ 
      /**
       * The `target` attribute sets an element for align the box dialog.
       *
       * @attribute target
       * @type String
       * @default null
       */ 
      /**
       * The `limit` attribute sets the limit lines.
       *
       * @attribute limit
       * @type integer
       * @default 5
       */               
      author: 'Horacio Ibrahim',                  
      publish: {
        showThumbs: true,
        iterable: [],
        opened: false,
        target: null,
        limit: 5, // each item has 60.7813px
        maxHeight: 60.7813 * this.limit + "px", // 4 x 60.7813 = 243
      },
      created: function() {

      },
      ready: function() {
        this.coreMenu = this.$.coreMenu;
        this.$.dropdop.style.margin = 0;
        this.$.dropdop.$.scroller.style.padding = 0;
        this.$.dropdop.$.scroller.style.maxWidth = "100%";
        this.$.dropdop.$.scroller.style.maxHeight = this.maxHeight;
        this.$.coreMenu.style.margin = 0;  
        
        document.addEventListener('core-activate', function(){
          var mythis = this.querySelector('sc-boxselect');
          mythis.selection();
        });

        document.addEventListener('core-overlay-close-completed', function(){
          var mythis = this.querySelector('sc-boxselect');
          mythis.opened = false;
        }); 

        document.addEventListener('core-overlay-open-completed', function() {
          var overlay = this.querySelector('core-overlay-layer.core-opened');
          var mythis = this.querySelector('sc-boxselect');
          overlay.style.maxHeight = mythis.maxHeight;
          if (mythis.target != null) {
            var target = document.querySelector('#' + mythis.target);
            var overlay = this.querySelector('core-overlay-layer.core-opened');
            mythis.setPosition(target, overlay);
          }  

        });

      },  
      openedChanged: function() {
        this.$.dropdop.opened = this.opened;
      }, 
      selection: function() {
        var model = this.$.coreMenu.selectedModel;
        this.opened = false;
        this.fire('selected-user', {response: {'content': model.item.content, 
                                        'thumbnail': model.item.thumbnail}});
      },
      /**
       * Adds elements in box dialog but limited at limit attribute.
       *
       * @param thumbnail - sets the thumbnail 
       * @param content - sets the content 
       * @method setItems
       */ 
      setItems: function(thumbnail, content) {
        var data = {'thumbnail': thumbnail, 'content': content};
        if (this.iterable.length < this.limit) {
          this.iterable.push(data); // TODO add/push testesj
        }
      },
      setPosition: function(targetElem, overlay) {
        h = targetElem.offsetHeight;
        t = targetElem.offsetTop - overlay.offsetHeight;
        l = targetElem.offsetLeft;
        w = targetElem.offsetWidth;
        overlay.style.top = t + "px";
        overlay.style.left = l + "px";;
        overlay.style.width = w + "px";;
      }
    });
  </script>

</polymer-element>
